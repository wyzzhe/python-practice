# AI Agent

## 前后端架构设计说明

### 意图说明

#### 详细意图表

- chat # 其他意图 (你好)
- food (我想吃火锅)
- confirm # 确认意图(就这家店吧)
  - <u>反复确认用户意向无法退出?</u>

> 无上下文时直接输入就这家店吧也会 -> confirm 意图

---

- store_introduction # 店铺介绍+导航(我想吃巴奴毛肚火锅的毛肚)
  - 暂时没有店铺介绍，只有简要文字+导航
- general_recommend # 通用店铺推荐(书店)
  - 可以输出推荐理由+导航

> 问明确的店铺名字，如巴奴、瑞幸 -> store_introduction 意图
>
> 问某一店铺类别，包括书店、买衣服等 -> general_recommend 意图

---

- navigation # 店铺导航(我想去巴奴毛肚火锅)
- infrastructure # 设施导航(洗手间在哪？)

> 问基础设施，包括洗手间、电梯等 -> infrastructure 意图
>
> 问美食购物店铺 -> navigation 意图

---

- find_car
- member
- credit
- discount # 麦记牛奶公司有什么优惠?

---

- ~~bind_car~~ # 绑定车牌做到了 chat 意图里



- ~~shop_clothes # ?~~
- ~~service # 生活服务？~~
- ~~queue_search # 未启用？~~
- ~~store_queue # 未启用？~~
- 



- ~~种类：活动推荐~~
- ~~种类：投诉建议_投诉~~
- ~~种类：投诉建议_建议~~
- ~~种类：停车_停车~~
- ~~种类：停车_停车场~~

#### 简略意图表

del_ 为询问之后会清意图

- chat # 你好
  - del_

- food 我想吃火锅
  - 无del_ 用rewrite实现意图切换

- confirm # 就这家店吧
  - 有条件del_ 存在当"退出"时无限循环进confirm的bug


- store_introduction # 我想吃巴奴毛肚火锅的毛肚
- general_recommend # 书店
  - del_


- navigation # 我想去巴奴毛肚火锅
  - del_

- infrastructure # 洗手间在哪？
  - del_


- find_car # 我车停哪儿了
  - del_ 用rewrite实现意图切换
- member # 会员权益
  - del_
- credit # 我还剩多少积分
  - del_ "换一换"考虑rewrite实现
- discount # 麦记牛奶公司有什么优惠?
  - del_

### HTTP请求方式

请求方式：post

body：

路由：today_index

Handler：TodayHandler

```
{
  "user_input": "今日风向标",
  "place_id": 801
}
```

路由：question

Handler：ModelHandler

```
{
  "user_input": "会员权益",
  "place_id": 801
}
```

路由：consumptionContext

Handler：ConsumptionContextHandler

```
{
  "place_id": 801,
  "txt": "独享时刻(一个人)"
}
```

路由：history

Handler：HistoryHandler

```
{
  "place_id": 801,
  "user_id": "G2GJV8RPoUh35wLd",
  "session_id": "G2GJV8RPoUh35wLd"
}
```

### 前端选项卡说明

#### 今日风向标

路由：today_index

#### 餐饮美食



#### 导航寻店



#### 寻车缴费

意图：find_car

#### 会员权益

意图：member

#### 人工客服

路由：跳转链接

意图：

#### 场景选择

路由：consumptionContext

意图：

响应：

```
{
    "request_id": "2a0957d3-8992-4a06-9039-a8d235f507e2",
    "error_no": 200,
    "error_msg": "success",
    "data": {
        "status": 0
    }
}
```

#### 清理消息

路由：history

请求方式：DELETE

请求内容类型：text/plain;charset=UTF-8 纯文本格式

意图：

响应：

```
{
    "request_id": "786ba570-b5ad-46f7-8c51-6deb74c7a320",
    "error_no": 200,
    "error_msg": "success",
    "data": {
        "status": 1
    }
}
```

### 上下文管理

- request

  - request_id
  - place_id
  - user_id # 正弘城user_id == token
  - user_input
  - header_intention
  - globalInfo # globalInfo == RedisUserContext

  

- RedisUserContext
  - user_id
  - consumptionContext
  - place_id
  - exclude_store_list
  - exclude_gift_list
  - send_food_first
  - food_history_user # 用户需求历史 奶茶, 火锅, 星巴克...
  - food_history_assistant # 助手推荐历史 店铺...
  - historyStoreType # "food"
  - historyStoreIDList
  - old_rewritten_question # 请推荐火锅 &&&



- agent_current_intention:801_G2GJV8RPoUh35wLd
  - member
  - 

### 餐饮美食技术路线图

Q: "有日料店吗"

>  意图识别

`验证登录` `缓存意图` `意图识别` `切入智能体` 

`智能体退出` `重新识别意图` 

- 意图识别
  - 验证登录
  - 缓存意图
  - 意图识别

- 切入智能体
  - 加载历史
  - 加载prompt和model
  - 问题重写
  - 加载数据
  - 产生结果



> 餐饮美食

`问题重写` `意图识别` `同类推荐`

`RAG检索` `过滤店铺` 

### 相似店铺推荐

不走大模型，直接sql查询并推荐店铺，保留`food` 意图

### 多轮对话意图切换

`foodRewrite` `findCarRewrite` 输入改写prompt

### 退出意图

- 无关意图输出`exit` 

- 排除`food` `find_car` 等意图

- 设置意图退出标志`intention_status` 

- 重新识别意图

### 美食 -> 确认

- `food` 意图下输入就这家吧
- food:原始问题：['请推荐奶茶&&&', '就这家吧'] 问题改写：exit
- 排除`food` 识别为`confirm` 
- 输出`confirm` 下的确认店铺问询
- 清除`confirm` 意图

### 换一换

”换一换“则上次对话输入内容不变

food:原始问题：['请推荐奶茶&&&', '换一换'] 问题改写：请推荐奶茶&&&

## 需求

### 积分兑换推荐逻辑

五个推荐位置：

​	1.吃货专场

​	2.吃货专场

​	3.居家生活 + 更多好物+

​	4.美妆类（美容护理、美妆护理专区、臻选护肤美妆、积分加购大牌美妆）

​	5.积分夺宝



# 知识库

## 正弘城店铺RAG参数

餐饮店铺：150家

其他店铺：400家

一级业态：

- 美食：薛记炒货

- 购物：名创优品

- 休闲娱乐：CGV影城

- 生活服务：樊文花面部护理

数据库：

- 美食店铺：点都德正弘城店
- 美食品牌：点都德
- 美食菜品：红米肠

- 购物店铺：名创优品正弘城店
- 购物品牌：名创优品

# 后端技术

` doModelAgent()`

#### 流式输出

`streamPrint == True` 

​	`sendStream` 流式输出

​	`sse.py`今日风向标提示词`todayIndexFood`

​	`chat意图`提示词`getChat`

​	`confirm意图` 如果在`优惠意图`下使用提示词`discountResult`

​	`credit意图` 提示词`creditResult`

​	`discount意图` 提示词`discountResult`

​	`general_recommend意图` 提示词`recommendResultTmp`

​	`member意图` 提示词`memberResult`

​	`parking意图` 提示词`findCarResult`

​	~~`store_queue意图` 提示词`queueResult`~~

​	`weather意图` 提示词`""`

#### 非流式输出

`streamPrint == False` 

​	先接收完整结果，对结果进行处理后再返回给前端

​	`intention.py` 

​	提示词意图识别`intentionPrompt` 需根据意图走不同分支且不需要返回给前端，所以先接受完整结果。

​	提示词查询地图中标记的店铺`checkInputHasStore` 需对大模型返回的店铺名称`84612` 进行处理，所以先接受完整结果。

​	`confirm意图` 

​	提示词确认店铺`confirmStore`确认店铺会返回诸如`[23141]|||已经为您找到星巴克，请问，您需要我帮我做什么？` 的信息，需要对`|||` 进行分割处理，所以先接受完整结果。

​	`discount意图`

​	提示词查询优惠店铺`searchDiscount` 需对大模型返回的`[23141, 34567]` 进行处理，所以先接受完整结果。

​	`general_recommend意图`	提示词店铺分类`generalStoreFilter` 需对大模型返回的`[23141, 34567]` 进行处理，所以先接受完整结果。

​	`infrastructure意图` 

​	提示词查询优惠店铺`infrastructureMatch` 需对大模型返回的`[23141, 34567]` 进行处理，所以先接受完整结果。

​	`navigation意图` 

​	提示词匹配可导航店铺`matchStore`会返回诸如`暂时没有找到星巴克，如果您想喝咖啡，我可以帮您推荐一个。|||我想喝咖啡帮我推荐一个` 的信息，需要对`|||` 进行分割处理，所以先接受完整结果。

​	`store_introduction意图` matchQueueStore

​	提示词查询优惠店铺`getStoreList` 需对大模型返回的`[23141, 34567]` 进行处理，所以先接受完整结果。

​	~~`store_queue意图`~~ 

​	~~提示词查询优惠店铺`matchQueueStore` 需对大模型返回的`[23141, 34567]` 进行处理，所以先接受完整结果。~~

​	`audio2txt.py` 

​	语音转文字

​	`sync_other_store_note.py` 

​	提示词`makeOtherNoteOffline` 



## 日志

### 调用大模型

`[LLM First Token Time]`

`[LLM Total Tokens Time]`

`[LLM Token Usage]` 

```
response.response_metadata = {
	'model_name' = '',
	'token_usage' = {}
}
```













